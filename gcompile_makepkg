#!/usr/bin/perl

# *******************************************************************
# gcompile: a runtime compiler for IDL
# 
# Copyright (C) 2015 Giorgio Calderone
# 
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public icense
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.
# 
# *******************************************************************

if ($#ARGV != 0) { die "Usage: gcompile_makepkg <package name> <path>"; }

$pkgName = lc($ARGV[0]);

print "Writing file: make_$pkgName.pro\n";
open ($out, "> make_$pkgName.pro") || die("Cannot open file make_$pkgName.pro for writing");


print $out ";;*******************************************************************\n";
print $out ";; PRO: make_$pkgName: compile and initialize package $pkgName\n";
print $out ";;\n";
print $out ";; USAGE:\n";
print $out ";;   - put this file in the package directory (e.g., /path/to/$pkgName)\n";
print $out ";;   - compile and initialize the package with:\n";
print $out ";;       gcompile, /package, 'path/to/$pkgName/make_$pkgName.pro'\n";
print $out ";;\n";
print $out ";; NOTE: this file was automatically generated by gcompile_makepkg\n";
print $out ";;\n";

print $out "PRO make_$pkgName, path\n";
print $out "  COMPILE_OPT IDL2\n";
print $out "  ON_ERROR, 2\n\n";

for ($pass=1; $pass<=2; $pass++) {
    open($in, "find . -iname '*.pro' | grep -v make_$pkgName | sort |"); 
    while (<$in>) {
        chomp;

        if ($pass == 1) {
            open($pro, "cat $_ |");
            while (<$pro>) {
	chomp;
	if (/^function +.+/i) {
	    s/function +//ig; 
	    s/,.*//g; 
	    print $out "  FORWARD_FUNCTION $_\n";
	}
            }
            close $pro;
        }


        if ($pass == 2) {
            s/\.\///;
            print $out "  gcompile, path + '$_'\n";
        }
    }
    close $in;
    print $out "\n";
}

print $out "END\n";
close $out;


